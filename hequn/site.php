<?phpdefined("IN_IA") or exit("Access Denied");class GTF_cybModuleSite extends WeModuleSite {  //   public function doMobileindex() {  //       global $_GPC, $_W;  //       $uniacid = $_W['uniacid'];			// $item = pdo_fetch("SELECT * FROM ".tablename('hequn_test_setting')." WHERE uniacid = :uniacid ", array(':uniacid' => $uniacid));				// $date = array();				// $date['uniacid'] = $uniacid;		// $date['openid'] = $_W['fans']['from_user'];		// $date['realname'] = $_W['fans']['nickname'];		// $date['touxiang'] = $_W['fans']['headimgurl'];		// $date['zc_time'] = time();						// $re = pdo_fetch("SELECT * FROM ".tablename('hequn_test_user')." WHERE openid = :openid and uniacid = :uniacid ", array(':openid' => $date['openid'],':uniacid' => $uniacid));				// if(empty($re)){		// 	 pdo_insert('hequn_test_user', $date);		// }				// if($_GPC['op'] == 'jieshu'){		// 	$jilu = pdo_fetch("SELECT * FROM ".tablename('hequn_test_rank')." WHERE khid = :khid and uniacid = :uniacid ", array(':khid' => $re['id'],':uniacid' => $uniacid));					// 	$da = array(		// 		'uniacid' => $uniacid,		// 		'khid' => $re['id'],		// 		'realname' => $re['realname'],		// 		'num' => $_GPC['num']		// 	);					// 	if($jilu){		// 		pdo_update('hequn_test_rank',$da, array('uniacid' => $uniacid,'khid'=>$re['id']));		// 	}else{		// 		pdo_insert('hequn_test_rank', $da);		// 	}		// }		  //       include $this->template('index');  //   }	public function doWebsetting() {        global $_GPC, $_W;        $uniacid = $_W['uniacid'];				$item = pdo_fetch("SELECT * FROM ".tablename('hequn_test_setting')." WHERE uniacid = :uniacid ", array(':uniacid' => $uniacid));				if (checksubmit('submit')){						$data = array(				'uniacid' => $uniacid,				'fxtitle' => $_GPC['title'],				'fxneirong' => $_GPC['content'],				'fxtupian' => $_GPC['thumb'],				'uniacqrcode' => $_GPC['uniacqrcode'],        		'uniacname' => $_GPC['uniacname'],        		'uniacavatar' => $_GPC['uniacavatar']			);						if($item){				pdo_update('hequn_test_setting',$data, array('uniacid' => $uniacid));			}else{				pdo_insert('hequn_test_setting', $data);			}	        //生成公众号标题图片	        $bg_path = "../addons/gtf_cyb/template/mobile/images/index.jpg";			$avatar_path = "../attachment/".$_GPC['uniacavatar'];						$avatar_save_path = "../attachment/" . substr($_GPC['uniacavatar'], 0, strripos($_GPC['uniacavatar'], '/'));						$bgImg = imagecreatefromjpeg($bg_path);			$avatarImg = imagecreatefromjpeg($avatar_path);			$width = imagesx($avatarImg);			$height = imagesy($avatarImg);			$scale_h = 80;			$sacle_w = (80 / $height) * $width;			$temp = ImageCreateTrueColor($sacle_w, $scale_h); // 获取新图			$transparent=imagecolorallocate($temp, 255, 255, 255);			imagefill($temp, 0, 0, $transparent);			imagecolortransparent($temp,$transparent);						imagecopyresampled($temp,$avatarImg,0,0,0,0,$sacle_w, $scale_h,imagesx($avatarImg),imagesy($avatarImg));			imagecopymerge($bgImg, $temp, 50, 50, 0, 0, $sacle_w, $scale_h, 100);			//保存头像图片			imagejpeg($bgImg, $avatar_save_path.'/index_'.$uniacid.'.jpg');	        //生成结果图片	        $res_path = "../addons/gtf_cyb/template/mobile/images/res";			$qr_path = "../attachment/".$_GPC['uniacqrcode'];						$res_save_path = "../attachment/hequn_test";			$results = $this->scanFile($res_path);			//var_dump($results);exit;			foreach($results as $img){				$imgUrl = $res_path .'/'. $img;								$img1 = imagecreatefromjpeg($imgUrl);				$img2 = imagecreatefromjpeg($avatar_path);				$img3 = imagecreatefromjpeg($qr_path);				$size_img = getimagesize($imgUrl);				$img_W = $size_img[0];				$img_H = $size_img[1];				$size_avatar  = getimagesize($avatar_path);				$avatar_W = $size_avatar[0];				$avatar_H = $size_avatar[1];				$scale_h = 40;				$scale_w = (40 / $avatar_H) * $avatar_W;								$temp2 = ImageCreateTrueColor($scale_w, $scale_h); // 获取新图				$transparent=imagecolorallocate($temp2, 255, 255, 255);				imagefill($temp2, 0, 0, $transparent);								imagecolortransparent($temp2,$transparent);								imagecopyresampled($temp2,$img2,0,0,0,0,$scale_w, $scale_h,$avatar_W,$avatar_H);				imagecopymerge($img1, $temp2, 66, $img_H-80, 0, 0, $scale_w, $scale_h, 100);								$size_qrcode = getimagesize($qr_path);				$qrcode_W = $size_qrcode[0];				$qrcode_H = $size_qrcode[1];								//imagecopyresampled($img1,$img2, 66, $img_H-80 , 0, 0, 187, 50, $avatar_W, $avatar_H);				imagecopyresampled($img1,$img3, 552, $img_H-179.5 , 0, 0, 120, 120, $qrcode_W, $qrcode_H);				imagejpeg($img1, $avatar_save_path.'/'.$img);				imagedestroy($img1);				imagedestroy($img2);				imagedestroy($img3);			}				      	imagedestroy($bgImg);			imagedestroy($avatarImg);	      	header('location: '.$_SERVER['HTTP_REFERER']);	      	exit;		}         include $this->template('setting');    }    function generateImage($img, $avatar, $qrcode){				$img1 = imagecreatefromjpeg($img);		$img2 = imagecreatefromjpeg($avatar);		$img3 = imagecreatefromjpeg($qrcode);		$size_img = getimagesize($img);		$img_W = $size_img[0];		$img_H = $size_img[1];		$size_avatar  = getimagesize($avatar);		$avatar_W = $size_avatar[0];		$avatar_H = $size_avatar[1];		$scale_h = 40;		$scale_w = (40 / $avatar_H) * $avatar_W;				$temp = ImageCreateTrueColor($scale_w, $scale_h); // 获取新图		$transparent=imagecolorallocate($temp, 255, 255, 255);		imagefill($temp, 0, 0, $transparent);				imagecolortransparent($temp,$transparent);				imagecopyresampled($temp,$img2,0,0,0,0,$scale_w, $scale_h,$avatar_W,$avatar_H);		imagecopymerge($img1, $temp, 66, $img_H-80, 0, 0, $scale_w, $scale_h, 100);				$size_qrcode = getimagesize($qrcode);		$qrcode_W = $size_qrcode[0];		$qrcode_H = $size_qrcode[1];				//imagecopyresampled($img1,$img2, 66, $img_H-80 , 0, 0, 187, 50, $avatar_W, $avatar_H);		imagecopyresampled($img1,$img3, 566, $img_H-158 , 0, 0, 100, 100, $qrcode_W, $qrcode_H);		imagejpeg($img1, $newImg);	}		public function doWebyonghu() {        global $_GPC, $_W;        $uniacid = $_W['uniacid'];				$yonghu = pdo_fetchall("SELECT * FROM ".tablename('hequn_test_user')." WHERE uniacid = :uniacid ", array(':uniacid' => $uniacid));				if($_GPC['op'] == 'lahei'){			pdo_update('hequn_test_rank',array('lh'=>1),array('khid'=>$_GPC['id']));		}		        include $this->template('yonghu');    }		public function doWebpaihang() {        global $_GPC, $_W;        $uniacid = $_W['uniacid'];				$paihang = pdo_fetchall("SELECT * FROM ".tablename('hequn_test_rank')." WHERE uniacid = :uniacid ", array(':uniacid' => $uniacid));		        include $this->template('paihangbang');    }    public function doMobileindex(){    	global $_GPC, $_W;        $uniacid = $_W['uniacid'];       // 	$mc = mc_oauth_userinfo();       //  if(!empty($mc['unionid'])){       //  	$fans = pdo_fetch('SELECT follow FROM ims_mc_mapping_fans WHERE uniacid='.$uniacid.' AND unionid="'.$mc['unionid'].'"');       //  } else {       //  	$fans = pdo_fetch('SELECT follow FROM ims_mc_mapping_fans WHERE uniacid='.$uniacid.' AND openid="'.$mc['openid'].'"');       //  }       //  // if($uniacid == 21){       //  // 	echo $fans['follow'];       //  // }       //  $res = pdo_fetch('SELECT * FROM ims_gtf_cyb_hequn_test WHERE uniacid='.$uniacid.' AND openid="'.$mc['openid'].'"');       //  if($res){       //  	if($res['subscribe'] != $fans['follow']){       //  		pdo_query('UPDATE ims_gtf_cyb_hequn_test SET subscribe='.$fans['follow'].' WHERE uniacid='.$uniacid.' AND openid="'.$mc['openid'].'"');       //  	}       //  } else {       //  	$sql = 'INSERT INTO ims_gtf_cyb_hequn_test VALUES ("", '.$uniacid.', "'.$mc['openid'].'", "'.$mc['unionid'].'", "'.$mc['avatar'].'", "'.$mc['nickname'].'", '.time().', 0, '.$fans['follow'].')';       //  	pdo_query($sql);       //  }        $setting = pdo_fetch('SELECT * FROM '.tablename('hequn_test_setting').' WHERE uniacid=:uniacid',array(':uniacid'=>$uniacid));        if(!empty($setting)){        	$imgUrl = "../attachment/" . substr($setting['uniacavatar'], 0, strripos($setting['uniacavatar'], '/'));        }        $assets = '/addons/gtf_cyb/template/mobile';            	include $this->template('index');    }  public function doMobileHougongzhuan(){    	global $_GPC, $_W;        $uniacid = $_W['uniacid'];                $mc = mc_oauth_userinfo();        if(!empty($mc['unionid'])){        	$fans = pdo_fetch('SELECT follow FROM ims_mc_mapping_fans WHERE uniacid='.$uniacid.' AND unionid="'.$mc['unionid'].'"');        } else {        	$fans = pdo_fetch('SELECT follow FROM ims_mc_mapping_fans WHERE uniacid='.$uniacid.' AND openid="'.$mc['openid'].'"');        }             	include $this->template('hougongzhuan');    }  function scanFile($path) {	  global $result;	  $files = scandir($path);	  foreach ($files as $file) {	    if ($file != '.' && $file != '..') {	      if (is_dir($path . '/' . $file)) {	        scanFile($path . '/' . $file);	      } else {	        $result[] = basename($file);	      }	    }	  }	  return $result;	}}