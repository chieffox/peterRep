(function () {
'use strict';

function getUrlParams(url) {
    var paramsStr = (url.split('?') || [])[1];

    if (paramsStr) {
        if (paramsStr.indexOf('#') > -1) {
            paramsStr = paramsStr.substring(0, paramsStr.indexOf('#'));
        }
        var params = {};

        paramsStr.split('&').map(function (paramStr) {
            var paramList = paramStr.split('=');

            params[paramList[0]] = paramList[1];

            if (params[paramList[0]] === undefined) {
                params[paramList[0]] = true;
            }
        });

        return params;
    }
}

function getUrlPathname(url) {
    url = url.split('?')[0];

    return url.replace('http://', '').replace('https://', '').replace('//', '').replace('m.you.163.com', '').replace('you.163.com', '') || '/';
}

function getUrlHost(url) {
    var host = url.replace('http://', '').replace('https://', '').replace('//', '');

    if (host.indexOf('/') > 1) {
        host = host.substring(0, host.indexOf('/'));
    }

    return host;
}

function convertUrlToMiniappUrl(url) {
    var params = getUrlParams(url);
    var pathname = getUrlPathname(url);

    if (pathname === '/') {
        return '/pages/index/index';
    }

    if (pathname === '/item/detail' && params.itemType != 6) {
        return '/pages/item/detail/index?id=' + params.id;
    }

    if (pathname === '/coupon') {
        return '/pages/coupon/list/index';
    }

    if (pathname === '/redpacket') {
        return '/pages/redPacket/list/index';
    }

    if (pathname === '/help') {
        return '/pages/webview/index?url=https%3A%2F%2Fm.you.163.com%2Fhelp';
    }

    if (pathname === '/item/list') {
        return '/pages/item/cate/index?cateId=' + params.categoryId + (params.subCategoryId ? '&subCateId=' + params.subCategoryId : '');
    }

    if (pathname === '/cart') {
        return '/pages/cart/index';
    }

    if (pathname === '/ucenter') {
        return '/pages/ucenter/list/index';
    }

    if (pathname === '/order/myList') {
        return '/pages/order/list/index';
    }

    if (pathname === '/item/itemAggregate' && params.id.indexOf('coupon') > -1) {
        return '/pages/itemPool/index?type=coupon&couponId=' + params.id.replace('coupon_', '');
    }

    if (pathname === '/cart/itemPool') {
        return '/pages/promItemPool/index?promId=' + params.promotionId;
    }
}

function convertUrlToAppUrl(url) {
    var params = getUrlParams(url);
    var pathname = getUrlPathname(url);

    if (params && params.newgoods && pathname === '/') {
        return 'yanxuan://newgoods';
    }

    if (params && params.popular && pathname === '/') {
        return 'yanxuan://popular';
    }

    if (pathname === '/') {
        return 'yanxuan://homepage';
    }

    if (pathname === '/item/detail' && params.itemType != 6) {
        return 'yanxuan://commoditydetails?commodityid=' + params.id + (params._stat_subject ? '&subject=' + params._stat_subject : '');
    }

    if (pathname === '/coupon') {
        return 'yanxuan://coupons';
    }

    if (pathname === '/redpacket') {
        return 'yanxuan://redenvelope';
    }

    if (pathname === '/help') {
        return 'yanxuan://helpcenter';
    }

    if (pathname === '/item/list') {
        if (params.subCategoryId) {
            return 'yanxuan://categoryl2?categoryid=' + params.subCategoryId;
        }

        return 'yanxuan://category?categoryid=' + params.categoryId;
    }

    if (pathname === '/cart') {
        return 'yanxuan://shoppingcart';
    }

    if (pathname === '/ucenter') {
        return 'yanxuan://mine';
    }

    if (pathname === '/order/myList') {
        return 'yanxuan://commodityorder';
    }

    return 'yanxuan://yxwebview?url=' + encodeURIComponent(url);
}

function isInMiniApp() {
    return window.__wxjs_environment === 'miniprogram';
}

function isInApp() {
    return navigator.userAgent.toLowerCase().match(/yanxuan/gi);
}

function openApp(appUrl, href) {
    if (document.getElementById('openAppIframe')) {
        return false;
    }
    var ifr = document.createElement('iframe');
    ifr.id = 'openAppIframe';
    ifr.src = appUrl;
    ifr.style.display = 'none';

    document.body.appendChild(ifr);
    setTimeout(function () {
        document.body.removeChild(ifr);
    }, 800);
}

function addEvent(evnt, elem, func) {
    if (elem.addEventListener) {
        elem.addEventListener(evnt, func, false);
    } else if (elem.attachEvent) {
        elem.attachEvent("on" + evnt, func);
    } else {
        elem[evnt] = func;
    }
}

function proxyLink(options) {
    addEvent('click', document.body, function (e) {
        var a;
        var url;
        var a = closestElement(e.target || e.srcElement, 'A');
        if (a && a.href && isYXUrl(a.href)) {
            if (a.target == '_blank') {
                options && options.onBeforeNavigate && options.onBeforeNavigate(a.href, a);
            } else {
                if (/^#/.test(a.getAttribute('href'))) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();

                options && options.onBeforeNavigate && options.onBeforeNavigate(a.href, a);

                setTimeout(function () {
                    if (isInMiniApp()) {
                        url = convertUrlToMiniappUrl(a.href);

                        if (url) {
                            return navigateToMiniApp({
                                url: url
                            });
                        }
                    }

                    if (isInApp()) {
                        url = convertUrlToAppUrl(a.href);
                        if (url) {
                            return openApp(url, a.href);
                        }
                    }

                    window.location.href = a.href;
                }, 150);
            }
        }
    });
}

function isYXUrl(url) {
    var host = getUrlHost(url);
    var YX_HOSTS = ['m.you.163.com', 'you.163.com', 'act.you.163.com'];

    return url && (YX_HOSTS.indexOf(host) > -1 || !host && url[0] === '/');
}

function closestElement(child, nodeName) {
    if (child.nodeName === nodeName) {
        return child;
    }

    if (!child.parentNode) {
        return;
    }

    if (child.parentNode.nodeName === nodeName) {
        return child.parentNode;
    }

    if (child.parentNode === document.body) {
        return;
    }

    return closestElement(child.parentNode, nodeName);
}

function navigateToMiniApp(options) {
    var MINIAPP_TAB_PAGES = ['/pages/index/index', '/pages/cart/index', '/pages/item/cateList/index', '/pages/ucenter/list/index'];

    var url = options.url;

    if (MINIAPP_TAB_PAGES.indexOf(url) > -1) {
        return window.wx.miniProgram.switchTab({
            url: url
        });
    }

    window.wx && window.wx.miniProgram.navigateTo({
        url: url
    });
}

var yx = {
    init: function init(options) {
        this.options = options;
        proxyLink(options);
    },

    login: function login(options) {
        options = options || {};
        options.callbackUrl = options.callbackUrl || window.location.href;

        window.wx && window.wx.miniProgram.redirectTo({
            url: '/pages/login/index?callbackUrl=' + encodeURIComponent(options.callbackUrl)
        });
    },

    isInMiniApp: isInMiniApp,

    isInApp: isInApp,

    navigateTo: function navigateTo(options) {
        setTimeout(function () {
            var url;

            if (this.isInMiniApp()) {
                url = convertUrlToMiniappUrl(options.url);

                if (url) {
                    return navigateToMiniApp({
                        url: url
                    });
                }
            }

            if (this.isInApp() || options.wakeup) {
                url = convertUrlToAppUrl(options.url);

                if (url) {
                    return openApp(url, options.url);
                }
            }

            window.location.href = options.url;
        }.bind(this), 150);
    },

    convertUrlToAppUrl: convertUrlToAppUrl,

    setShare: function setShare(options) {
        options = options || {};
        options.shareUrl = options.shareUrl || window.location.href;
        options.title = options.title || document.title;

        window.wx.miniProgram.postMessage({
            data: {
                shareConfig: options
            }
        });
    },

    openApp: openApp
};

window.yx = yx;

}());
